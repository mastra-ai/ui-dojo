import { createTool } from "@mastra/core/tools";
import { z } from "zod";

export const nestedWeatherAgentStreamTool = createTool({
  id: "nested-weather-agent-stream",
  description:
    "Use the weather agent inside tool to get the weather for a city",
  inputSchema: z.object({
    city: z.string().describe("The city to analyze weather for"),
  }),
  outputSchema: z.object({
    summary: z.string().describe("A concise weather summary generated by the nested agent"),
  }),
  // See https://mastra.ai/docs/streaming/tool-streaming#tool-using-an-agent
  execute: async ({ context, mastra, writer }) => {
    const { city } = context;

    const weatherAgent = mastra?.getAgent("weatherAgent");

    if (!weatherAgent) {
      return {
        summary: `Unable to run nested agent stream â€“ weather agent is not available for "${city}".`,
      };
    }

    // Stream the nested agent from inside this tool.
    // Mastra will emit nested data-tool-agent and data-tool-workflow parts that can
    // be rendered by the UI as part of the same tool run.
    const stream = await weatherAgent.stream(
      `Analyze the current weather in ${city} and return a short, user-facing summary.`,
    );

    // Pipe the agent's textStream into the tool writer so the UI receives
    // nested and merged chunks while the tool is running.
    await stream!.fullStream.pipeTo(writer!);

    const text = await stream.text;

    return {
      summary:
        text ??
        `Finished nested agent run for ${city}, but no summary text was returned.`,
    };
  },
});